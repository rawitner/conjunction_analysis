---
title: "R Notebook"
output: html_document
---

# Conjunction Analysis

Testing functionality of R notebook.

```{r}
library(tidyverse)
library(RColorBrewer)
#all_conjs = readRDS("all_conjs")
derelicts = readRDS("derelicts")
#file_list = readRDS("file_list")
mcma_objs = readRDS("mcma_objs")
today = "22NOV2019"

path = "conj_data/"
file_list = list.files(path)
#file_list_new = list.files(path)
#file_list_new = file_list_new[!(file_list_new %in% file_list)] # only the new conjunctions

all_conjs = data.frame()
for (i in 1:length(file_list)) {
  temp_data = read_csv(paste0(path, file_list[i]))
  all_conjs = rbind(all_conjs, temp_data) #for each iteration, bind the new data to the building dataset
}

# column for cluster combination
for (r in 1:nrow(all_conjs)) {
  clusts = sort(c(all_conjs$PrimaryCluster[r], all_conjs$SecondaryCluster[r]), decreasing = T)
  all_conjs$clusters[r] = paste0(clusts[1], "-", clusts[2])
}

# column for unique cluster, if a number and LEO or HIGH, only label as the number
all_conjs =  all_conjs %>%
  mutate(firstClust = gsub("-.*$", "", clusters),
         secondClust = sub(".*?-", "", clusters),
         clusterLab = if_else(firstClust=="LEO" & secondClust=="LEO", "LEO",
                              if_else(firstClust=="LEO" & secondClust!="LEO", "LEO-other",
                                      if_else(firstClust=="HIGH" & secondClust=="HIGH", "HIGH",
                                              if_else(firstClust=="HIGH" & secondClust!="HIGH", 
                                                      "HIGH-other", firstClust)))),
         clusterLab = factor(clusterLab,
           levels = c("615", "775", "850", "975", "1200", "1500", "LEO","LEO-other","HIGH-other"),
           ordered = T))

# read in country codes
country_codes = read_csv("./country_codes.csv", 
                         col_names = c("country", "Country"), col_types = "cc", skip = 1) %>%
  mutate(Country = str_to_title(Country),
         Country = if_else(str_length(Country) > 20, country, Country))

# plot percent of encounters by country
p = all_conjs %>%
  mutate(noradId = as.numeric(gsub("--.*$", "", PrimarySatellite ))) %>%
  left_join(dplyr::select(mcma_objs, c(noradId, country)), by="noradId") %>%
  mutate(country = if_else(country == "CHBZ", "PRC", country)) %>%
  group_by(clusterLab, country) %>% 
  summarise(numEncounters = n()) %>%
  left_join(country_codes, by="country") %>% 
  group_by(clusterLab) %>%
  mutate(encountersPerClust = sum(numEncounters), 
         p = numEncounters / encountersPerClust * 100) %>%
  group_by(clusterLab) %>%
  mutate(country_new = if_else(p < 2, "Other", Country)) %>% 
  mutate(p = if_else(country_new=="Other", mean(p[country_new=="Other"]), p))

colourCount = length(unique(p$country_new))
getPalette = colorRampPalette(brewer.pal(9, "Set1"))

ggplot() + 
  geom_bar(data = p, aes(x=clusterLab, y=p/100, group=country_new, fill=country_new), stat="identity")+
  geom_text(data = unique(dplyr::select(p, c(clusterLab, encountersPerClust))), position = position_stack(vjust=1.05), 
            aes(x=clusterLab, y=1, label=encountersPerClust))+
  theme_minimal() +
  scale_y_continuous(labels = scales::percent) + 
  scale_fill_manual(values = getPalette(colourCount))+
  labs(x="Cluster",y="", title = "Percent of Encounters by Country", fill="Country",
       subtitle="Number of encounters shown above each bar", caption=paste0("Encounters from 20OCT2019-", today))

ggsave(paste0("output/percentEncountersByCountry_", today, ".jpeg"),device="jpeg")
```

